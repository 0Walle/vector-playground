<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vector Playground</title>
    <link rel="stylesheet" href="mathquill/mathquill.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="mathquill/mathquill-basic.js"></script>
    <script src="defs.js"></script>
    <script src="parser.js"></script>
    <style>
        body {
            margin: 0px;
            background-color: #002b36;
        }

        #view {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: 100vh;
        }

        #defs {
            min-width: 400px;
            border-right: 1px solid #839496;
            display: flex;
            flex-direction: column;
            max-height: 100vh;
            overflow-y: scroll;
            scrollbar-width: none;
        }

        #defs .def-div {
            color: #fdf6e3;
            font-size: 115%;
            border-bottom: 1px solid #657b83;
            display: flex;
            flex-direction: row;
            /* padding: 15px; */
        }

        #box-container {
            width: 100%;
        }

        #objs {
            position: absolute;
            z-index: 10;
        }

        .math-field {
            border: none;
            box-shadow: none !important;
            width: calc(90% - 40px);
            margin: 15px;
        }

        span .mq-cursor {
            border-left: 1px solid #fdf6e3 !important;
        }

        .color-button {
            border-radius: 50%;
            /* background: salmon; */
            width: 20px;
            height: 20px;
            margin: 0 auto;
            top: calc(50% - 10px);
            position: relative;
        }

        .color-sel {
            width: 40px;
            height: 100%;
            background: #073642;
        }

        /**************************************/

        .toogle-switch {
            position: relative;
            display: inline-block;
            width: 35px;
            height: 20px;
        }

        .toogle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toogle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #073642;
            -webkit-transition: .4s;
            transition: background-color .4s;
            border-radius: 34px;
        }

        .toogle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 2px;
            background-color: #fdf6e3;
            -webkit-transition: .4s;
            transition: background-color .4s;
            transition: transform .4s;
            border-radius: 50%;
        }

        input:checked + .toogle-slider {
            background-color: #657b83;
        }
    
        input:checked + .toogle-slider:before {
            -webkit-transform: translateX(14px);
            -ms-transform: translateX(14px);
            transform: translateX(14px);
        }

        #config-selector {
            position: absolute;
            left: 0px;
            top: 0px;
            padding: 5px;
            background: #002b36;
            border: 1px solid #657b83;
            border-radius: 5px;
            color: #fdf6e3;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            z-index: 100;
        }
    </style>
</head>
<body oncontextmenu="return false;">
    <div id="view">
        <div id="defs">
            <div onclick="new_object()" id="new-ref" class="def-div">
                <div class="color-sel"><div class="color-button"></div></div>
                <span style="font-size: 115%; margin: 15px; display: block;">&nbsp;</span>
            </div>
        </div>
        <div id="box-container">
            <canvas id="grid"></canvas>
            <canvas id="objs"></canvas>
        </div>
    </div>
    <div id="config-selector" style="visibility: hidden;">
        <div>
            <label>Draggable</label>
            <label class="toogle-switch">
                <input type="checkbox" id="draggable">
                <span class="toogle-slider"></span>
            </label>
        </div>
    </div>
    <script type="text/javascript">
        const MQ = MathQuill.getInterface(2);

        const config_selector = document.getElementById("config-selector");

        let Graph = {
            pan_x: 0,
            pan_y: 0,
            objects: [],
            selected: false,
            mousedown: false,
            fields: [],
            mouse: {x: 0, y: 0}
        }

        let Canvas = {
            element: document.getElementById("grid"),
            ctx: null,
            obj_layer: document.getElementById("objs"),
            obj_ctx: null,

            init() {
                const rect = document.getElementById("box-container").getBoundingClientRect();
                this.element.width = rect.width;
                this.element.height = rect.height - 5;

                Graph.pan_x = rect.width/2;
                Graph.pan_y = rect.height/2;

                this.obj_layer.style.left = rect.x + 'px';
                this.obj_layer.style.top = rect.top;
                this.obj_layer.width = rect.width;
                this.obj_layer.height = rect.height - 5;

                this.ctx = this.element.getContext('2d');
                this.obj_ctx = this.obj_layer.getContext('2d')
            },

            update() {
                const size = {
                    x: this.element.clientWidth,
                    y: this.element.clientHeight,
                }

                this.ctx.clearRect(0, 0, size.x, size.y);
                this.obj_ctx.clearRect(0, 0, size.x, size.y);

                this.ctx.lineWidth = 0.5;
                this.ctx.strokeStyle = "#839496";
                this.ctx.fillStyle = "#fdf6e3";

                const number_x_start = Math.trunc(-Graph.pan_x / step);
                const number_y_start = Math.trunc(-Graph.pan_y / step);

                for (let i = 0; i <= Math.trunc(size.x / step) + 1; i++) {
                    if (i + number_x_start != 0) {
                        this.ctx.fillText(
                            String(i + number_x_start),
                            (Graph.pan_x % step) + i * step + 4,
                            Math.min(Math.max(Graph.pan_y + 16, 16), size.y));

                        this.ctx.beginPath();
                        this.ctx.moveTo((Graph.pan_x % step) + i * step, 0);
                        this.ctx.lineTo((Graph.pan_x % step) + i * step, size.y);
                        this.ctx.stroke();
                    }
                }

                for (let i = 0; i <= Math.trunc(size.y / step) + 1; i++) {
                    if (i + number_y_start != 0) {
                        this.ctx.fillText(
                            String(i + number_y_start),
                            Math.min(Math.max(Graph.pan_x + 8, 8), size.x - 16),
                            (Graph.pan_y % step) + i * step - 4);

                        this.ctx.beginPath();
                        this.ctx.moveTo(0, (Graph.pan_y % step) + i * step);
                        this.ctx.lineTo(size.x, (Graph.pan_y % step) + i * step);
                        this.ctx.stroke();
                    }
                }

                this.ctx.lineWidth = 2;
                this.ctx.strokeStyle = "#fdf6e3";

                this.ctx.beginPath();
                this.ctx.moveTo(Graph.pan_x, 0);
                this.ctx.lineTo(Graph.pan_x, size.y);
                this.ctx.stroke();

                this.ctx.beginPath();
                this.ctx.moveTo(0, Graph.pan_y);
                this.ctx.lineTo(size.x, Graph.pan_y);
                this.ctx.stroke();


                this.obj_ctx.lineWidth = 4;

                let environment = {
                    'i': { func: () => new Vec(1, 0), val: undefined },
                    'j': { func: () => new Vec(0, 1), val: undefined },
                };

                for (const field of Graph.fields) {
                    if (field.ast == undefined) continue;

                    environment[field.obj_name] = {
                        func: field.ast,
                        val: undefined,
                        field: field,
                    }
                }

                if (Graph.selected) {
                    environment[Graph.selected.name] = {
                        func: Graph.selected.func,
                        val: undefined,
                        field: Graph.selected.field
                    }
                }

                for (const name in environment) {
                    const obj = environment[name];

                    const result = typeof obj.func == 'function' ? obj.func() 
                                 : execute_ast(obj.func, environment)

                    this.obj_ctx.strokeStyle = obj.field.obj_color;
                    this.obj_ctx.fillStyle = obj.field.obj_color;

                    if (result instanceof Vec) {
                        let dist = Math.hypot(Graph.mouse.x - result.x, Graph.mouse.y - result.y);
                        if (dist <= 0.1 && obj.field.obj_draggable) {
                            this.obj_ctx.beginPath();
                            this.obj_ctx.arc(
                                result.x * step + Graph.pan_x,
                                result.y * step + Graph.pan_y,
                                4, 0, 2 * Math.PI);
                            this.obj_ctx.fill();

                            if (Graph.mousedown) {
                                Graph.selected = {
                                    name: name,
                                    func: () => new Vec(Graph.mouse.x, Graph.mouse.y),
                                    field: obj.field
                                }
                            }
                        }

                        draw_arrow(this.obj_ctx,
                            Graph.pan_x,
                            Graph.pan_y,
                            result.x * step,
                            result.y * step,
                        );
                    }
                }
            },
        }

        window.addEventListener("mousemove", e => {
            e.preventDefault();
            
            if (e.buttons & 2) {
                Graph.pan_x += e.movementX;
                Graph.pan_y += e.movementY;
            } 

            if (Graph.selected) {

                const latex = Graph.selected.name.length > 2 ? 
                    `\\left(${Graph.mouse.x.toFixed(2)},${Graph.mouse.y.toFixed(2)}\\right)`
                    : `${Graph.selected.name}=\\left(${Graph.mouse.x.toFixed(2)},${Graph.mouse.y.toFixed(2)}\\right)`

                Graph.selected.field.latex(latex);
            }


            let [sx, sy] = snap2((e.offsetX - Graph.pan_x)/step, (e.offsetY - Graph.pan_y)/step)
            Graph.mouse.x = sx;
            Graph.mouse.y = sy;
            Canvas.update();
        })

        window.addEventListener("mousedown", e => {
            if (e.target != config_selector && !config_selector.contains(e.target)) {
                config_selector.style.visibility = 'hidden';
            }
            

            if (e.buttons & 1) {
                e.preventDefault();

                Graph.mousedown = true;
                Canvas.update();
                Graph.mousedown = false;
            }
        })

        window.addEventListener("mouseup", e => {
            Graph.selected = null;

            Canvas.update();
        })

        window.addEventListener("resize", e => {
            Canvas.element.width = 0;
            Canvas.element.height = 0;
            Canvas.obj_layer.width = 0;
            Canvas.obj_layer.height = 0;

            const rect = document.getElementById("box-container").getBoundingClientRect();
            Canvas.element.width = rect.width;
            Canvas.element.height = rect.height - 5;

            Graph.pan_x = rect.width/2;
            Graph.pan_y = rect.height/2;

            Canvas.obj_layer.style.left = rect.x + 'px';
            Canvas.obj_layer.style.top = rect.top;
            Canvas.obj_layer.width = rect.width;
            Canvas.obj_layer.height = rect.height - 5;
            
            Canvas.update();
        })


        Canvas.init();
        Canvas.update();

        let p = Point(2, 1);
        Graph.objects.push(p);

        function new_object(color = 0){
            const new_div = document.getElementById('new-ref');
            const defs_div = document.getElementById('defs');
            const div = document.createElement('div');
            div.classList.add('def-div');
            const div1 = document.createElement('div');
            div1.classList.add('color-sel');
            const div2 = document.createElement('div');
            div2.classList.add('color-button');
            div1.appendChild(div2);
            div.appendChild(div1);

            color = colors[Math.floor(Math.random() * colors.length)];

            div2.style.background = color;

            const span = document.createElement('span');
            span.classList.add('math-field');
            div.appendChild(span)

            defs_div.insertBefore(div, new_div);

            let v = Vector(0, 0);
            Graph.objects.push(v);
            v.color = color;
            
            let math_field = MQ.MathField(span, {
                handlers: {
                    edit: function() {
                        let format = math_field.text();
                        console.log(format)
                        if (!format) return;
                        let ast
                        try {
                            ast = parse_expression({source: format});
                        } catch(e) {
                            math_field.ast = undefined;
                            Canvas.update();
                            return;
                        }

                        if (ast.kind == 'op' && ast.op == '=') {
                            math_field.ast = ast.rhs;
                            math_field.obj_name = ast.lhs.val;
                        } else {
                            math_field.ast = ast;
                            math_field.obj_name = '______' + String(math_field.id);
                            console.log(math_field.id)
                        }

                        Canvas.update();
                    }
                },
                autoCommands: 'pi theta sqrt',
            });

            math_field.focus();

            math_field.ast = undefined;
            math_field.obj_name = undefined;
            math_field.obj_color = color;
            math_field.obj_draggable = false;

            div2.onclick = (e) => {
                config_selector.style.visibility = 'visible';
                config_selector.style.left = e.pageX + 'px';
                config_selector.style.top = e.pageY + 'px';

                let input = document.getElementById('draggable');
                input.checked = math_field.obj_draggable;

                input.onchange = (e) => {
                    math_field.obj_draggable = input.checked;
                }
            };

            Graph.fields.push(math_field);
        }

        Canvas.update();
    </script>
</body>
</html>